# 编辑样式和技术规范

本页描述了在编辑整本指南时， 作者们所采用的方法， 样式和特殊的设定。

## 方法和样式

本指南拥有大量的潜在读者。它可以提供给第一次接触 R 语言的研究人员。 同时，对于拥有丰富 R 语言开发经验的研究人员， 他们也能从中获得经验和帮助。 本书容易理解且相对简洁。 其核心在于提供**充足**的解释性语句， 让初学者能够运行代码且理解代码的含义。

此外：

-   这是一本代码参考指南，附带了相对简明的示例 ------ **不是**关于 R 或数据科学的教科书；\
-   这是一本在"应用流行病学"领域中使用 **R 语言**的指南 ------ **不是**应用流行病学的指南或手册；\
-   本指南旨在成为一份动态文本 ------ 用于特定任务的 R packages 经常更迭，我们欢迎大家加入关于本指南中应该强调的内容的讨论。

### R packages  {.unnumbered}

**多样的 R packages**

在学习 R 语言的过程中， 最具挑战的事情是了解哪一个 R package 可以用来实现特定的功能。 有时， 在手动编写完一项功能后， 研究人员会忽然意识到 ------ 嘿！ 有一个 R package 可以用一行代码实现此功能！

在本指南中，我们试图为你提供至少两种方法来完成每项任务：一种是相对稳妥的方法 （可能基于 **base** R 或者 **tidyverse** ）；另一种是为该任务或功能定制的 R package。 我们希望你拥有多种选择，以防你无法下载某个 R package 或者 它不适合你的编码环境。

在选择 R package 时， 我们优先考虑那些经过社区测试以及审核的 R package。 尽量减少在一个任务中使用的 R package 数量。 这些 R package 是相对稳定的， 并且能够简单干净的完成任务。

本指南一般优先考虑来自 **tidyverse** 的 R packages 和函数。 Tidyverse 是一个为数据科学设计的 R packages 的集合，其内部共享底层语法和数据结构。 所有 tidyverse packages 都可以通过 **tidyverse** 来安装或加载。 更多信息请参考 [tidyverse website](https://www.tidyverse.org/) 。

在适当情况下， 我们还提供基于 **base** R的代码。 **Base** R 是 R 语言在安装时附带的 packages 和函数。 这是由于我们意识到某些读者可能没有一个稳定的网络环境来下载格外的 R packages。

**简明地链接函数与 packages**

在部分 R 教程中，你经常会在代码中看到一个函数但却不知道它来自于哪个 R package 。 这是非常令人沮丧的， 我们会在本指南中避免这种情况的发生。

在说明文本中，package 名字会被加粗（例如 **dplyr** ）。而函数则被写成 `mutate()` 。我们通过在附近的文本中引用 package 或者在代码中明确指定package（例如 `dplyr::mutate()`），来描述函数来自于哪个 package 。看起来可能会有些重复，但这是作者们故意用来明确函数的来源。

阅读 [ R 基础 ] 页面来了解更多关于 R packages 和函数的信息。

### 代码样式 {.unnumbered}

在本指南中，我们经常使用 "换行" ，这会显得我们的代码很 "长" 。 这样做有以下几个原因：

-   我们可以用 \# 在代码的每个小部分旁边写解释性注释；\
-   通常来说，垂直较长的代码更容易被理解；\
-   在较窄屏幕上阅读代码更容易 （不需要横向滚动）；\
-   通过缩进，可以更容易地知道哪个参数属于哪个函数。

因此，**最初**被编写成这种格式的代码：

```{r, eval=F}
linelist %>% 
  group_by(hospital) %>%  # 按照医院进行分组
  slice_max(date, n = 1, with_ties = F) # 如果出现相同的行（基于日期），只返回一行
```

被编写成：

```{r, eval=F}
linelist %>% 
  group_by(hospital) %>% # 按照医院进行分组
  slice_max(
    date,                # 基于最大日期来排列组
    n = 1,               # 只保留第一行
    with_ties = F)       # 如果出现相同的行（基于日期），只返回一行
```

R 代码通常不受换行或缩进的影响。 编写代码时， 如果你在逗号后开始新的一行， R 将开始自动缩进模式。

我们还使用了很多空格（例如 `n = 1` 而不是 `n=1`），因为它更容易被阅读。 善待阅读代码的人！

### 术语 {.unnumbered}

在本指南中，我们一般用 "列 "和 "行 "来代替 "变量 "和 "观测结果"。正如这篇关于 "[tidy data](https://tidyr.tidyverse.org/articles/tidy-data.html) "的入门文章中所解释的，大多数流行病学的统计数据集的结构由行、列和数值组成。

**变量**包含同一属性的值（例如基于年龄组，结果或发病日期）。 **观测结果**包含在同一单位上测量的所有值（例如一个人、地点或实验室样本）。 这些可能很难被明确地定义。

在 "tidy 整洁 "的数据集中，每一列是一个变量，每一行是一个观察结果，每一个单元格是一个单一的值。然而，一些数据集并不符合这种模式 ------ 一个 "wide 宽 "的数据集中可能有一个变量被分割成几列（如 [数据透视] 页面中的一个例子）。同样地，观测结果也可能被分割成几行。

这本指南的大部分内容是关于数据管理和数据转换的。因此，将数据集看作行列结构更有意义。例外情况主要出现在有关数据分析的页面中。在这些页面你会看到更多关于变量和观测结果的使用。

### 注释 {.unnumbered}

以下是你在指南中可能遇到的注释类型：

[**注释：**这是一个注释。]{style="color: black;"}\
[**提示：**这是一个提示。]{style="color: darkgreen;"}\
[**警示：**这是一个警示。]{style="color: orange;"}\
[**警告 :** 这是一个警告。]{style="color: red;"}

## 设定

下表是我们对于 package 和函数选择的主要设定。如果你有不同意见或者想提供一个新的工具，请在我们的 [Github page](https://github.com/appliedepi/epirhandbook_eng) 联系我们。

**表：Package，函数和其他设定**

+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 对象         | 待选                                                                             | 最终结果                                                                               | 主要理由                                                       |
+==============+==================================================================================+========================================================================================+================================================================+
| 通用编码方式 | **tidyverse**, **data.table**, **base**                                          | **tidyverse**，有一个页面用 **data.table**。 **base** 作为替代，对于那些没有网络的读者 | **tidyverse** 可读性、普遍性、最多人使用                       |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| Package 加载 | `library()`,`install.packages()`, `require()`, **pacman**                        | **pacman**                                                                             | 为大多数 Package 的安装或加载提供简化代码                      |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 导入和导出   | **rio**, many other packages                                                     | **rio**                                                                                | 可轻松处理多种文件类型                                         |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 统计数据分组 | **dplyr** `group_by()`, **stats** `aggregate()`                                  | **dplyr** `group_by()`                                                                 | 与 **tidyverse** 的特点一致                                    |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 表格透视     | **tidyr** (pivot functions), **reshape2** (melt/cast), **tidyr** (spread/gather) | **tidyr** (pivot functions)                                                            | **reshape2** 已不再更新, **tidyr** 可用 pivot functions v1.0.0 |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 清理列名     | **linelist**, **janitor**                                                        | **janitor**                                                                            | 强调合并 packages                                              |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 流行病学周   | **lubridate**, **aweek**, **tsibble**, **zoo**                                   | **lubridate** 比较普遍，其他的针对具体情况                                             | **lubridate's** 灵活性、一致性、维护较好                       |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| ggplot 标签  | `labs()`, `ggtitle()`/`ylab()`/`xlab()`                                          | `labs()`                                                                               | 所有标签在一个地方、简单                                       |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 转换为因子   | `factor()`, **forcats**                                                          | **forcats**                                                                            | 它的函数也会被转换为因子在同一命令下                           |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 流行曲线     | **incidence**, **ggplot2**, **EpiCurve**                                         | **incidence2** 更快速, **ggplot2** 更细节                                              | 可靠性                                                         |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+
| 串联         | `paste()`, `paste0()`, `str_glue()`, `glue()`                                    | `str_glue()`                                                                           | 和 **stringr** 一起是一种比粘贴函数更简单的语法                |
+--------------+----------------------------------------------------------------------------------+----------------------------------------------------------------------------------------+----------------------------------------------------------------+

## 主要修订

| 日期         | 主要变动      |
|--------------|---------------|
| 10 五月 2021 |  发布版本1.0.0|

## 版本信息 (R, RStudio, packages)

以下是有关本指南使用过程中使用的 R、RStudio 和 R packages 的版本信息。

```{r}
sessioninfo::session_info()
```
